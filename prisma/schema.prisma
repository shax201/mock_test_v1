generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://neondb_owner:npg_s0i7MxjcIhCd@ep-late-dust-a17jlpvf-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
}

model ListeningTest {
  id            String          @id @default(cuid())
  title         String          @default("IELTS Listening Test")
  audioSource   String          @map("audio_source")
  instructions  Json
  totalTimeMinutes Int          @default(30) @map("total_time_minutes")
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  readingTestId String?         @map("reading_test_id")
  parts         ListeningPart[]
  readingTest   ReadingTest?    @relation(fields: [readingTestId], references: [id])

  @@map("listening_tests")
}

model ListeningPart {
  id              String              @id @default(cuid())
  listeningTestId String              @map("listening_test_id")
  index           Int
  title           String
  prompt          Json
  sectionTitle    String?
  courseRequired  String?
  matchingHeading String?
  matchingOptions Json?
  notesSections   Json?
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  listeningTest   ListeningTest       @relation(fields: [listeningTestId], references: [id], onDelete: Cascade)
  questions       ListeningQuestion[]

  @@unique([listeningTestId, index])
  @@map("listening_parts")
}

model ListeningQuestion {
  id              String                @id @default(cuid())
  listeningPartId String                @map("listening_part_id")
  number          Int
  type            ListeningQuestionType
  labelPrefix     String?
  textPrefix      String?
  textSuffix      String?
  questionText    String?
  options         Json?
  matchingLabel   String?
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  field           Json?
  groupId         String?               @map("group_id")
  imageUrl        String?               @map("image_url")
  answers         Json?
  tableStructure  Json?
  correctAnswer   ListeningAnswer?
  part            ListeningPart         @relation(fields: [listeningPartId], references: [id], onDelete: Cascade)

  @@unique([listeningPartId, number])
  @@map("listening_questions")
}

model ListeningAnswer {
  id         String            @id @default(cuid())
  questionId String            @unique @map("question_id")
  answer     Json
  createdAt  DateTime          @default(now()) @map("created_at")
  updatedAt  DateTime          @updatedAt @map("updated_at")
  question   ListeningQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("listening_answers")
}

model User {
  id           String        @id @default(cuid())
  name         String?
  email        String        @unique
  passwordHash String        @map("password_hash")
  role         UserRole
  phone        String?
  dateOfBirth  DateTime?     @map("date_of_birth")
  address      String?
  notes        String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  assignments  Assignment[]
  testSessions TestSession[]

  @@map("users")
}

model ReadingTest {
  id               String           @id @default(cuid())
  title            String
  totalQuestions   Int              @default(40)
  totalTimeMinutes Int              @default(60)
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  writingTestId    String?          @map("writing_test_id")
  assignments      Assignment[]
  bandScoreRanges  BandScoreRange[]
  listeningTests   ListeningTest[]
  passageConfigs   PassageConfig[]
  passages         Passage[]
  writingTests     WritingTest[]

  @@map("reading_tests")
}

model Passage {
  id               String            @id @default(cuid())
  readingTestId    String            @map("reading_test_id")
  title            String
  order            Int
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  contents         PassageContent[]
  readingTest      ReadingTest       @relation(fields: [readingTestId], references: [id], onDelete: Cascade)
  questions        Question[]
  writingQuestions WritingQuestion[]

  @@map("passages")
}

model PassageContent {
  id        String  @id @default(cuid())
  passageId String  @map("passage_id")
  contentId String  @map("content_id")
  text      String
  order     Int
  passage   Passage @relation(fields: [passageId], references: [id], onDelete: Cascade)

  @@unique([passageId, contentId])
  @@map("passage_contents")
}

model Question {
  id             String              @id @default(cuid())
  passageId      String              @map("passage_id")
  questionNumber Int                 @map("question_number")
  type           ReadingQuestionType
  questionText   String              @map("question_text")
  options        Json?
  headingsList   Json?               @map("headings_list")
  summaryText    String?             @map("summary_text")
  subQuestions   Json?               @map("sub_questions")
  imageUrl       String?             @map("image_url")
  field          Json?
  fields         Json?
  points         Int                 @default(1)
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  correctAnswer  CorrectAnswer?
  passage        Passage             @relation(fields: [passageId], references: [id], onDelete: Cascade)

  @@map("questions")
}

model CorrectAnswer {
  id         String   @id @default(cuid())
  questionId String   @unique @map("question_id")
  answer     String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("correct_answers")
}

model BandScoreRange {
  id            String      @id @default(cuid())
  readingTestId String      @map("reading_test_id")
  minScore      Int         @map("min_score")
  band          Float
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  readingTest   ReadingTest @relation(fields: [readingTestId], references: [id], onDelete: Cascade)

  @@unique([readingTestId, minScore])
  @@map("band_score_ranges")
}

model PassageConfig {
  id            String      @id @default(cuid())
  readingTestId String      @map("reading_test_id")
  part          Int
  total         Int
  start         Int
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  readingTest   ReadingTest @relation(fields: [readingTestId], references: [id], onDelete: Cascade)

  @@unique([readingTestId, part])
  @@map("passage_configs")
}

model TestSession {
  id          String    @id @default(cuid())
  testId      String    @map("test_id")
  studentId   String    @map("student_id")
  testType    String    @map("test_type")
  itemWiseTestId String?  @map("item_wise_test_id")
  itemWiseTest   ItemWiseTest? @relation(fields: [itemWiseTestId], references: [id], onDelete: SetNull)
  startedAt   DateTime? @map("started_at")
  answers     Json?
  isCompleted Boolean   @default(false) @map("is_completed")
  completedAt DateTime? @map("completed_at")
  score       Int?
  band        Float?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  overallBand Float?    @map("overall_band")
  student     User      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("test_sessions")
}

model WritingTest {
  id               String                 @id @default(cuid())
  title            String
  totalTimeMinutes Int                    @default(60)
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now()) @map("created_at")
  updatedAt        DateTime               @updatedAt @map("updated_at")
  readingTestId    String                 @map("reading_test_id")
  passageConfigs   WritingPassageConfig[]
  passages         WritingPassage[]
  readingTest      ReadingTest            @relation(fields: [readingTestId], references: [id], onDelete: Cascade)

  @@map("writing_tests")
}

model WritingPassage {
  id            String                  @id @default(cuid())
  writingTestId String                  @map("writing_test_id")
  order         Int
  createdAt     DateTime                @default(now()) @map("created_at")
  updatedAt     DateTime                @updatedAt @map("updated_at")
  title         String
  contents      WritingPassageContent[]
  writingTest   WritingTest             @relation(fields: [writingTestId], references: [id], onDelete: Cascade)
  questions     WritingQuestion[]

  @@map("writing_passages")
}

model WritingPassageContent {
  id        String         @id @default(cuid())
  passageId String         @map("passage_id")
  contentId String         @map("content_id")
  text      String
  order     Int
  passage   WritingPassage @relation(fields: [passageId], references: [id], onDelete: Cascade)

  @@unique([passageId, contentId])
  @@map("writing_passage_contents")
}

model WritingQuestion {
  id               String              @id @default(cuid())
  passageId        String              @map("passage_id")
  questionText     String              @map("question_text")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")
  points           Int                 @default(1)
  questionNumber   Int                 @map("question_number")
  readingPassageId String?             @map("reading_passage_id")
  type             WritingQuestionType
  passage          WritingPassage      @relation(fields: [passageId], references: [id], onDelete: Cascade)
  readingPassage   Passage?            @relation(fields: [readingPassageId], references: [id])

  @@map("writing_questions")
}

model WritingPassageConfig {
  id            String      @id @default(cuid())
  writingTestId String      @map("writing_test_id")
  part          Int
  total         Int
  start         Int
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  writingTest   WritingTest @relation(fields: [writingTestId], references: [id], onDelete: Cascade)

  @@unique([writingTestId, part])
  @@map("writing_passage_configs")
}

model Assignment {
  id            String           @id @default(cuid())
  studentId     String           @map("student_id")
  readingTestId String           @map("reading_test_id")
  status        AssignmentStatus @default(PENDING)
  validFrom     DateTime         @map("valid_from")
  validUntil    DateTime         @map("valid_until")
  accessToken   String           @unique @map("access_token")
  assignedAt    DateTime         @default(now()) @map("assigned_at")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  readingTest   ReadingTest      @relation(fields: [readingTestId], references: [id], onDelete: Cascade)
  student       User             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("assignments")
}

model ItemWiseTest {
  id               String                   @id @default(cuid())
  title            String
  isActive         Boolean                  @default(true)
  testType         ItemWiseTestType
  questionType     ItemWiseTestQuestionType
  moduleType       ItemWiseModuleType       @default(READING) @map("module_type")
  createdAt        DateTime                 @default(now()) @map("created_at")
  updatedAt        DateTime                 @updatedAt @map("updated_at")
  readingTestIds   String[]                 @map("reading_test_ids")
  listeningTestIds String[]                 @map("listening_test_ids")
  writingTestIds   String[]                 @map("writing_test_ids")
  sessions         TestSession[]

  @@map("item_wise_tests")
}

model SiteSettings {
  id            String   @id @default(cuid())
  logoUrl       String?  @map("logo_url")
  faviconUrl    String?  @map("favicon_url")
  logoPublicId  String?  @map("logo_public_id")
  faviconPublicId String? @map("favicon_public_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("site_settings")
}

enum ItemWiseTestType {
  ITEM_WISE_TEST
}

enum ItemWiseTestQuestionType {
  FLOW_CHART_COMPLETION
}

enum ItemWiseModuleType {
  READING
  LISTENING
  WRITING
}

enum UserRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum ModuleType {
  READING
}

enum QuestionType {
  MCQ
  FIB
  MATCHING
  TRUE_FALSE
  NOT_GIVEN
  TRUE_FALSE_NOT_GIVEN
  NOTES_COMPLETION
  SUMMARY_COMPLETION
  MULTIPLE_CHOICE
}

enum ListeningQuestionType {
  TEXT
  RADIO
  SELECT
  FLOW_CHART
  TABLE_COMPLETION
}

enum AssignmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  EXPIRED
}

enum ReadingQuestionType {
  MATCHING_HEADINGS
  MATCHING_INFORMATION
  TRUE_FALSE_NOT_GIVEN
  SUMMARY_COMPLETION
  MULTIPLE_CHOICE
  // New type for reading flow-chart style questions
  FLOW_CHART
}

enum WritingQuestionType {
  TASK_1
  TASK_2
}
