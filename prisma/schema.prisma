// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://neondb_owner:npg_s0i7MxjcIhCd@ep-late-dust-a17jlpvf-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
}

enum UserRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum ModuleType {
  READING
}

enum QuestionType {
  MCQ
  FIB
  MATCHING
  TRUE_FALSE
  NOT_GIVEN
  TRUE_FALSE_NOT_GIVEN
  NOTES_COMPLETION
  SUMMARY_COMPLETION
  MULTIPLE_CHOICE
}

enum AssignmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  EXPIRED
}

enum ReadingQuestionType {
  MATCHING_HEADINGS
  MATCHING_INFORMATION
  TRUE_FALSE_NOT_GIVEN
  SUMMARY_COMPLETION
  MULTIPLE_CHOICE
}

model User {
  id           String   @id @default(cuid())
  name         String?
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole
  phone        String?
  dateOfBirth  DateTime? @map("date_of_birth")
  address      String?
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  testSessions TestSession[]

  @@map("users")
}

// Reading Test Models

// Main reading test entity
model ReadingTest {
  id               String   @id @default(cuid())
  title            String
  totalQuestions   Int      @default(40)
  totalTimeMinutes Int      @default(60)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  passages        Passage[]
  bandScoreRanges BandScoreRange[]
  passageConfigs  PassageConfig[]

  @@map("reading_tests")
}

// Individual passages within a reading test
model Passage {
  id          String   @id @default(cuid())
  readingTestId String   @map("reading_test_id")
  title       String
  order       Int      // Order of passage in the test
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  readingTest    ReadingTest    @relation(fields: [readingTestId], references: [id], onDelete: Cascade)
  contents       PassageContent[]
  questions      Question[]

  @@map("passages")
}

// Content segments within a passage
model PassageContent {
  id        String @id @default(cuid())
  passageId String @map("passage_id")
  contentId String @map("content_id") // A, B, C, D, E, etc.
  text      String
  order     Int   // Order within the passage

  // Relations
  passage Passage @relation(fields: [passageId], references: [id], onDelete: Cascade)

  @@unique([passageId, contentId])
  @@map("passage_contents")
}

// Questions belonging to passages
model Question {
  id             String   @id @default(cuid())
  passageId      String   @map("passage_id")
  questionNumber Int      @map("question_number") // 1, 2, 3, etc.
  type           ReadingQuestionType
  questionText   String   @map("question_text")
  options        Json?    // For multiple choice questions
  headingsList   Json?    @map("headings_list") // For matching headings questions
  summaryText    String?  @map("summary_text") // For summary completion questions
  subQuestions   Json?    @map("sub_questions") // For multi-blank summary completions (e.g., ["5", "6", "7"])
  points         Int      @default(1)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  passage       Passage       @relation(fields: [passageId], references: [id], onDelete: Cascade)
  correctAnswer CorrectAnswer?

  @@map("questions")
}

// Correct answers for questions
model CorrectAnswer {
  id         String   @id @default(cuid())
  questionId String   @unique @map("question_id")
  answer     String   // The correct answer (could be text, option letter, etc.)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("correct_answers")
}

// Band score calculation ranges
model BandScoreRange {
  id            String  @id @default(cuid())
  readingTestId String  @map("reading_test_id")
  minScore      Int     @map("min_score") // Minimum score to achieve this band
  band          Float   // Band score (e.g., 9.0, 8.5, etc.)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  readingTest ReadingTest @relation(fields: [readingTestId], references: [id], onDelete: Cascade)

  @@unique([readingTestId, minScore])
  @@map("band_score_ranges")
}

// Passage configuration for question distribution
model PassageConfig {
  id            String  @id @default(cuid())
  readingTestId String  @map("reading_test_id")
  part          Int     // Part number (1, 2, 3)
  total         Int     // Total questions in this part
  start         Int     // Starting question number for this part
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  readingTest ReadingTest @relation(fields: [readingTestId], references: [id], onDelete: Cascade)

  @@unique([readingTestId, part])
  @@map("passage_configs")
}

// Test sessions for students taking tests
model TestSession {
  id         String   @id @default(cuid())
  testId     String   @map("test_id") // Can reference reading tests or other test types
  studentId  String   @map("student_id")
  testType   String   @map("test_type") // READING, LISTENING, etc.
  startedAt  DateTime? @map("started_at")
  answers    Json?    // Student answers stored as JSON
  isCompleted Boolean  @default(false) @map("is_completed")
  completedAt DateTime? @map("completed_at")
  score      Int?     // Final score
  band       Float?   // Band score
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("test_sessions")
}


