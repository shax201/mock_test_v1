// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://neondb_owner:npg_s0i7MxjcIhCd@ep-late-dust-a17jlpvf-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
}

enum UserRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum ModuleType {
  LISTENING
  READING
  WRITING
  SPEAKING
}

enum QuestionType {
  MCQ
  FIB
  MATCHING
  TRUE_FALSE
  NOT_GIVEN
  TRUE_FALSE_NOT_GIVEN
  NOTES_COMPLETION
  SUMMARY_COMPLETION
  MULTIPLE_CHOICE
}

enum AssignmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  EXPIRED
}

model User {
  id           String   @id @default(cuid())
  name         String?
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole
  phone        String?
  dateOfBirth  DateTime? @map("date_of_birth")
  address      String?
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  createdMocks     Mock[]           @relation("MockCreator")
  assignments      Assignment[]
  instructorMarks  InstructorMark[]
  writingFeedback  WritingFeedback[]
  remedialSessions RemedialTestSession[]
  remedialTemplates RemedialTestTemplate[]

  @@map("users")
}



// Remedial Test Session - Tracks student remedial test sessions
model RemedialTestSession {
  id        String   @id @default(cuid())
  studentId String   @map("student_id")
  templateId String? @map("template_id")
  testType  String   @map("test_type")
  status    String   @default("ACTIVE")
  answers   Json?
  score     Int?
  startedAt DateTime @map("started_at")
  completedAt DateTime? @map("completed_at")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  template RemedialTestTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@map("remedial_test_sessions")
}

// Remedial Test Template - Templates for creating remedial tests
model RemedialTestTemplate {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String   // MATCHING_HEADINGS, INFORMATION_MATCHING, etc.
  module      String   // READING, LISTENING, etc.
  difficulty  String   @default("INTERMEDIATE") // BEGINNER, INTERMEDIATE, ADVANCED
  duration    Int      @default(20) // in minutes
  questions   Json     // Question data
  audioUrl    String?  @map("audio_url") // Audio file URL for LISTENING module
  audioPublicId String? @map("audio_public_id") // Cloudinary public ID for audio file
  mockTestId  String?  @map("mock_test_id") // Link to specific mock test
  isActive    Boolean  @default(true)
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  mockTest Mock? @relation(fields: [mockTestId], references: [id], onDelete: SetNull)
  sessions RemedialTestSession[]

  @@map("remedial_test_templates")
}
